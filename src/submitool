#!/bin/bash

# Submitool - by Gaetan Suillerot
# version 2.0
# For those who want to push quicker or think 23h42 is too early

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}------------------------------------${NC}"
echo -e "${BLUE}SUBMITOOL - BY GAETAN SUILLEROT${NC}"
echo -e "${BLUE}Twitter/X @gaetanslrt${NC}"
echo -e "${BLUE}Github @gaetanslrt${NC}"
echo -e "${BLUE}------------------------------------${NC}"
echo ""

# Find repository root using .git directory
find_repo_root() {
    local current_dir=$(pwd)
    
    while [[ "$current_dir" != "/" ]]; do
        if [[ -d "$current_dir/.git" ]]; then
            echo "$current_dir"
            return 0
        fi
        current_dir=$(dirname "$current_dir")
    done
    
    return 1
}

# Check if we're in a git repository
REPO_ROOT=$(find_repo_root)
if [[ -z "$REPO_ROOT" ]]; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Change to repository root
cd "$REPO_ROOT"

# Check git status
if ! git status &> /dev/null; then
    echo -e "${RED}Error: Not a valid git repository${NC}"
    exit 1
fi

echo -e "${GREEN}Repository found: $REPO_ROOT${NC}"

# Show current status
echo -e "${YELLOW}Current status:${NC}"
git status --short

# Ask for confirmation
read -p "Do you want to proceed with add/commit/push? (y/n): " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Operation cancelled"
    exit 0
fi

# Ask for tag
read -p "Do you want to add a tag? (y/n): " add_tag

# Ask for commit message
read -p "Enter commit message (or press enter for default): " commit_message
if [[ -z "$commit_message" ]]; then
    commit_message="Commited and pushed to remote with Submitool - by Gaetan Suillerot"
fi

# Execute git operations
echo -e "${YELLOW}Adding files...${NC}"
git add .

echo -e "${YELLOW}Committing...${NC}"
git commit -m "$commit_message"

if [[ "$add_tag" =~ ^[Yy]$ ]]; then
    read -p "Specify the EPITA tag name pattern (e.g., submit-*): " tag_pattern
    RANDOM_TAG_VALUE=$((1000000 + RANDOM % 9999999))
    
    # Replace * with random value in tag pattern
    if [[ "$tag_pattern" == *"*"* ]]; then
        EPITA_TAG_NAME="${tag_pattern//\*/$RANDOM_TAG_VALUE}"
    else
        EPITA_TAG_NAME="$tag_pattern-$RANDOM_TAG_VALUE"
    fi
    
    echo -e "${YELLOW}Creating tag: $EPITA_TAG_NAME${NC}"
    git tag -a "$EPITA_TAG_NAME" -m "Tag created by Submitool"
    
    echo -e "${YELLOW}Pushing to remote with tags...${NC}"
    git push --follow-tags
else
    echo -e "${YELLOW}Pushing to remote...${NC}"
    git push
fi

# Check if operation was successful
if [[ $? -eq 0 ]]; then
    echo -e "${GREEN}✓ Successfully pushed to remote!${NC}"
else
    echo -e "${RED}✗ Failed to push to remote${NC}"
    exit 1
fi
